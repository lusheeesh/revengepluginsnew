(function(l,f,s,u){"use strict";function d(i){const e=new Uint8Array(i);let t="";for(let o=0;o<e.length;o++)t+=String.fromCharCode(e[o]);if(typeof btoa<"u")return btoa(t);try{return globalThis.Buffer.from(e).toString("base64")}catch{return u.logger.warn("MP3ToVoiceNote: no base64 encoder available"),""}}function g(i,e=80){const t=i.getChannelData(0),o=Math.floor(t.length/e),a=new Uint8Array(e);for(let r=0;r<e;r++){let n=0;for(let c=0;c<o;c++)n+=Math.abs(t[r*o+c]||0);a[r]=Math.min(255,Math.round(n/o*255))}return a}async function h(i){try{const e=globalThis.AudioContext||globalThis.webkitAudioContext;if(e){const t=new e,o=await t.decodeAudioData(i.slice(0));return t.close?.(),o}}catch(e){u.logger.warn("MP3ToVoiceNote: decodeAudioData failed",e)}return null}async function m(i,e){try{let t=null,o=null;if(e&&typeof e.arrayBuffer=="function")try{const a=await e.arrayBuffer(),r=await h(a);if(r){t=r.duration;const n=g(r,80);o=d(n)}}catch(a){u.logger.warn("MP3ToVoiceNote: decoding failed",a)}if(!t&&e)try{const a=URL.createObjectURL(e),r=new Audio(a);t=await new Promise(function(n){const c=setTimeout(function(){return n(null)},3e3);r.addEventListener("loadedmetadata",function(){clearTimeout(c),n(r.duration)}),r.addEventListener("error",function(){clearTimeout(c),n(null)})}),URL.revokeObjectURL(a)}catch(a){u.logger.warn("MP3ToVoiceNote: HTMLAudio fallback failed",a)}t&&(i.durationSecs=Math.round(t*100)/100),o&&(i.waveform=o),i.mimeType?.startsWith("audio")&&(i.mimeType="audio/ogg")}catch(t){u.logger.warn("MP3ToVoiceNote: transform error",t)}}function y(){const i=[],e=function(t){try{const o=f.findByProps(t);if(!o)return;const a=s.before(t,o,function(r){const n=r[0];if(!n||u.storage?.sendAsVM===!1||n.flags===8192)return;const c=n.items?.[0]??n,w=n.items?.[0]?.file??n.file??n;c?.mimeType?.startsWith("audio")&&(m(c,w).then(function(){n.flags=8192}),n.flags=8192)});i.push(a)}catch(o){u.logger.warn("MP3ToVoiceNote: patch failed",o)}};return e("uploadLocalFiles"),e("CloudUpload"),function(){return i.forEach(function(t){return t()})}}return l.default=y,Object.defineProperty(l,"__esModule",{value:!0}),l})({},vendetta.metro,vendetta.patcher,vendetta);
